import { useState, useEffect, useContext } from "react";
import { useNavigate } from "react-router-dom";
import Grid from "@mui/material/Grid";
import Card from "@mui/material/Card";
import MDBox from "components/MDBox";
import MDTypography from "components/MDTypography";
import MDInput from "components/MDInput";
import MDButton from "components/MDButton";
import MDBadge from "components/MDBadge";
import DashboardLayout from "examples/LayoutContainers/DashboardLayout";
import DashboardNavbar from "examples/Navbars/DashboardNavbar";
import Footer from "examples/Footer";
import DataTable from "examples/Tables/DataTable";
import { AuthContext } from "../../AuthContext";
import api from "../../api";
import Icon from "@mui/material/Icon";
import MenuItem from "@mui/material/MenuItem";
import Select from "@mui/material/Select";
import FormControl from "@mui/material/FormControl";
import InputLabel from "@mui/material/InputLabel";

function Tickets() {
  const [tickets, setTickets] = useState([]);
  const [filteredTickets, setFilteredTickets] = useState([]);
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedCategory, setSelectedCategory] = useState("");
  const [selectedStatus, setSelectedStatus] = useState("");
  const [currentPage, setCurrentPage] = useState(1);
  const ticketsPerPage = 6;

  const { user } = useContext(AuthContext);
  const navigate = useNavigate();
  const isAdmin = user?.isAdmin || false;

  useEffect(() => {
    fetchTickets();
  }, []);

  useEffect(() => {
    filterTickets();
  }, [tickets, searchQuery, selectedCategory, selectedStatus]);

  const fetchTickets = async () => {
    try {
      const response = await api.get("/tickets/");
      setTickets(response.data);
    } catch (error) {
      console.error("Error fetching tickets:", error);
    }
  };

  const filterTickets = () => {
    let filtered = [...tickets];

    if (searchQuery) {
      filtered = filtered.filter(
        (ticket) =>
          ticket.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
          ticket.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
          ticket.created_by?.username.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }

    if (selectedCategory) {
      filtered = filtered.filter((ticket) => ticket.category === selectedCategory);
    }

    if (selectedStatus) {
      filtered = filtered.filter((ticket) => ticket.status === selectedStatus);
    }

    setFilteredTickets(filtered);
    setCurrentPage(1);
  };

  const handleDelete = async (id) => {
    if (!isAdmin) {
      alert("Only admin users can delete tickets");
      return;
    }
    
    if (window.confirm("Are you sure you want to delete this ticket?")) {
      try {
        await api.delete(`/tickets/${id}/`);
        alert("Ticket deleted successfully!");
        fetchTickets();
      } catch (error) {
        console.error("Error deleting ticket:", error);
        alert("Failed to delete ticket");
      }
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case "New":
        return "info";
      case "Under Review":
        return "warning";
      case "Resolved":
        return "success";
      default:
        return "default";
    }
  };

  const getCategoryColor = (category) => {
    switch (category) {
      case "Technical":
        return "error";
      case "Billing":
        return "warning";
      case "General":
        return "info";
      case "Other":
        return "default";
      default:
        return "default";
    }
  };

  // Pagination
  const indexOfLastTicket = currentPage * ticketsPerPage;
  const indexOfFirstTicket = indexOfLastTicket - ticketsPerPage;
  const currentTickets = filteredTickets.slice(indexOfFirstTicket, indexOfLastTicket);
  const totalPages = Math.ceil(filteredTickets.length / ticketsPerPage);

  return (
    <DashboardLayout>
      <DashboardNavbar />
      <MDBox pt={6} pb={3}>
        <Grid container spacing={6}>
          <Grid item xs={12}>
            <Card>
              <MDBox
                mx={2}
                mt={-3}
                py={3}
                px={2}
                variant="gradient"
                bgColor="info"
                borderRadius="lg"
                coloredShadow="info"
                display="flex"
                justifyContent="space-between"
                alignItems="center"
              >
                <MDTypography variant="h6" color="white">
                  Tickets
                </MDTypography>
                <MDButton
                  variant="contained"
                  color="white"
                  onClick={() => navigate("/tickets/create")}
                >
                  <Icon>add</Icon>&nbsp;Create New Ticket
                </MDButton>
              </MDBox>
              
              {/* Search and Filters */}
              <MDBox p={3}>
                <Grid container spacing={2} mb={3}>
                  <Grid item xs={12} md={6}>
                    <MDInput
                      type="text"
                      label="Search tickets..."
                      fullWidth
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                    />
                  </Grid>
                  <Grid item xs={12} md={3}>
                    <FormControl fullWidth>
                      <InputLabel>Category</InputLabel>
                      <Select
                        value={selectedCategory}
                        label="Category"
                        onChange={(e) => setSelectedCategory(e.target.value)}
                      >
                        <MenuItem value="">All Categories</MenuItem>
                        <MenuItem value="Technical">Technical</MenuItem>
                        <MenuItem value="Billing">Billing</MenuItem>
                        <MenuItem value="General">General</MenuItem>
                        <MenuItem value="Other">Other</MenuItem>
                      </Select>
                    </FormControl>
                  </Grid>
                  <Grid item xs={12} md={3}>
                    <FormControl fullWidth>
                      <InputLabel>Status</InputLabel>
                      <Select
                        value={selectedStatus}
                        label="Status"
                        onChange={(e) => setSelectedStatus(e.target.value)}
                      >
                        <MenuItem value="">All Statuses</MenuItem>
                        <MenuItem value="New">New</MenuItem>
                        <MenuItem value="Under Review">Under Review</MenuItem>
                        <MenuItem value="Resolved">Resolved</MenuItem>
                      </Select>
                    </FormControl>
                  </Grid>
                </Grid>

                {/* Tickets Grid */}
                <Grid container spacing={3}>
                  {currentTickets.length === 0 ? (
                    <Grid item xs={12}>
                      <MDBox textAlign="center" py={5}>
                        <MDTypography variant="h6" color="text">
                          No tickets found
                        </MDTypography>
                      </MDBox>
                    </Grid>
                  ) : (
                    currentTickets.map((ticket) => (
                      <Grid item xs={12} md={6} lg={4} key={ticket.id}>
                        <Card>
                          <MDBox p={2}>
                            <MDBox display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                              <MDTypography variant="h6" fontWeight="medium">
                                {ticket.title}
                              </MDTypography>
                              <Chip
                                label={ticket.status}
                                color={getStatusColor(ticket.status)}
                                size="small"
                              />
                            </MDBox>
                            
                            <MDTypography variant="body2" color="text" mb={2}>
                              {ticket.description.substring(0, 100)}...
                            </MDTypography>

                            <MDBox display="flex" gap={1} mb={2}>
                              <Chip
                                label={ticket.category}
                                color={getCategoryColor(ticket.category)}
                                size="small"
                                variant="outlined"
                              />
                              <Chip
                                icon={<Icon>person</Icon>}
                                label={ticket.created_by?.username || "Unknown"}
                                size="small"
                              />
                            </MDBox>

                            <MDBox display="flex" justifyContent="space-between" alignItems="center">
                              <MDTypography variant="caption" color="text">
                                {new Date(ticket.created_at).toLocaleDateString()}
                              </MDTypography>
                              <MDBox display="flex" gap={1}>
                                <MDButton
                                  variant="text"
                                  color="info"
                                  size="small"
                                  onClick={() => navigate(`/tickets/${ticket.id}`)}
                                >
                                  <Icon>visibility</Icon>&nbsp;View
                                </MDButton>
                                {isAdmin && (
                                  <>
                                    <MDButton
                                      variant="text"
                                      color="warning"
                                      size="small"
                                      onClick={() => navigate(`/tickets/edit/${ticket.id}`)}
                                    >
                                      <Icon>edit</Icon>
                                    </MDButton>
                                    <MDButton
                                      variant="text"
                                      color="error"
                                      size="small"
                                      onClick={() => handleDelete(ticket.id)}
                                    >
                                      <Icon>delete</Icon>
                                    </MDButton>
                                  </>
                                )}
                              </MDBox>
                            </MDBox>
                          </MDBox>
                        </Card>
                      </Grid>
                    ))
                  )}
                </Grid>

                {/* Pagination */}
                {totalPages > 1 && (
                  <MDBox display="flex" justifyContent="center" mt={4}>
                    <Pagination
                      count={totalPages}
                      page={currentPage}
                      onChange={(e, page) => setCurrentPage(page)}
                      color="info"
                    />
                  </MDBox>
                )}
              </MDBox>
            </Card>
          </Grid>
        </Grid>
      </MDBox>
      <Footer />
    </DashboardLayout>
  );
}

export default Tickets;
